{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4">Sign Document: {{ document.filename }}</h2>

  <div class="d-flex">
    <!-- PDF Canvas Container -->
    <div class="flex-grow-1 position-relative" id="pdfContainer" style="min-height:600px; border:1px solid #ccc; overflow:auto;">
      <canvas id="pdfCanvas" class="w-100"></canvas>

      <!-- Draggable Signature -->
      <div id="draggableSignature" style="position:absolute; display:none; cursor:move; z-index:10;">
        <img id="sigPreview" src="" style="width:150px; height:50px;">
      </div>

      <!-- Page Navigation -->
      <div id="pageControls" class="position-absolute" style="bottom:10px; left:10px; background:rgba(255,255,255,0.8); padding:5px; border-radius:5px;">
        <button id="prevPage" class="btn btn-sm btn-secondary">Prev</button>
        <span id="pageInfo">Page 1 / 1</span>
        <button id="nextPage" class="btn btn-sm btn-secondary">Next</button>
      </div>
    </div>

    <!-- Signature Panel -->
    <div id="signaturePanel" style="width:300px; margin-left:10px;">
      <h5>Draw Your Signature</h5>
      <div class="border mb-2" style="height:200px;">
        <canvas id="signaturePad" style="width:100%; height:100%;"></canvas>
      </div>
      <div class="d-flex gap-2 mb-3">
        <button id="clearSignature" class="btn btn-secondary btn-sm">Clear</button>
        <button id="placeSignature" class="btn btn-primary btn-sm">Place</button>
      </div>

      <h6>Saved Signatures</h6>
      <div id="savedSignatures" class="d-flex flex-wrap gap-2 mb-2"></div>
      <button id="saveSignature" class="btn btn-success btn-sm mb-2">Save Signature</button>

      <button id="saveDocument" class="btn btn-warning w-100 mb-2">Save Signed PDF</button>
      <button id="analyzeDocument" class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#analysisModal">Analyze Document</button>
    </div>
  </div>
</div>

<!-- Modal -->
<!-- Analysis Modal -->
<div class="modal fade" id="analysisModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Document Analysis</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="analysisResult">
        <div id="analysisSpinner" class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p>Analyzing document...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="closeAnalysisModal">Close</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block script %}
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.6.347/build/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // ---------- PDF.js ----------
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.6.347/build/pdf.worker.min.js';
  const pdfUrl = "{{ url_for('signature.docuploaded_file', filename=document.filename) }}";
  const pdfCanvas = document.getElementById("pdfCanvas");
  const pdfCtx = pdfCanvas.getContext("2d");
  const pdfContainer = document.getElementById("pdfContainer");
  const modalEl = document.getElementById("analysisModal");
  const analysisModal = new bootstrap.Modal(modalEl);
  const resultDiv = document.getElementById("analysisResult");
  const spinnerDiv = document.getElementById("analysisSpinner");
  let pdfDocInstance = null;
  let currentPage = 1;

  pdfjsLib.getDocument(pdfUrl).promise.then(doc => {
    pdfDocInstance = doc;
    document.getElementById("pageInfo").textContent = `Page ${currentPage} / ${doc.numPages}`;
    renderPage(currentPage);
  });

  function renderPage(pageNum){
    pdfDocInstance.getPage(pageNum).then(page => {
      const viewport = page.getViewport({ scale: 1.5 });
      const scale = pdfContainer.clientWidth / viewport.width;
      const scaledViewport = page.getViewport({ scale });
      pdfCanvas.width = scaledViewport.width;
      pdfCanvas.height = scaledViewport.height;
      page.render({ canvasContext: pdfCtx, viewport: scaledViewport });
      console.log(pdfContainer.clientWidth, viewport.width, scale);
      document.getElementById("pageInfo").textContent = `Page ${currentPage} / ${pdfDocInstance.numPages}`;
    });
  }

  document.getElementById("prevPage").addEventListener("click", () => {
    if(currentPage>1){ currentPage--; renderPage(currentPage); }
  });
  document.getElementById("nextPage").addEventListener("click", () => {
    if(currentPage<pdfDocInstance.numPages){ currentPage++; renderPage(currentPage); }
  });

  // ---------- Signature Pad ----------
  const sigCanvas = document.getElementById("signaturePad");
  const sigPad = new SignaturePad(sigCanvas);
  document.getElementById("clearSignature").addEventListener("click", () => sigPad.clear());

  const dragDiv = document.getElementById("draggableSignature");
  const sigPreview = document.getElementById("sigPreview");
  const savedContainer = document.getElementById("savedSignatures");
  let isDragging=false, offsetX=0, offsetY=0;

  document.getElementById("placeSignature").addEventListener("click", ()=>{
    if(sigPad.isEmpty()) return;
    sigPreview.src = sigPad.toDataURL();
    dragDiv.style.display = "block";
    dragDiv.style.left = "20px"; dragDiv.style.top="20px";
  });

  dragDiv.addEventListener("mousedown", e => { isDragging=true; offsetX=e.offsetX; offsetY=e.offsetY; });
  document.addEventListener("mousemove", e => {
    if(!isDragging) return;
    const rect = pdfContainer.getBoundingClientRect();
    dragDiv.style.left = Math.max(0, e.pageX-rect.left-offsetX)+"px";
    dragDiv.style.top = Math.max(0, e.pageY-rect.top-offsetY)+"px";
  });
  document.addEventListener("mouseup", ()=>isDragging=false);

  // ---------- Save Signature ----------
  document.getElementById("saveSignature").addEventListener("click", async ()=>{
    if(sigPad.isEmpty()) return alert("Draw signature first");
    const resp = await fetch("{{ url_for('signature.save_signature') }}", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({signature:sigPad.toDataURL(), doc_id:"{{ document.id }}"})
    });
    const data = await resp.json();
    if(data.success){
      alert("Signature saved!");
      sigPreview.src = data.signature_url;
      dragDiv.style.display="block";
      dragDiv.style.left="20px"; dragDiv.style.top="20px";
      loadSavedSignatures(); // refresh panel
    }
  });

  // ---------- Load Saved Signatures ----------
  async function loadSavedSignatures(){
    savedContainer.innerHTML = "";

    // Fetch saved signatures from your backend endpoint
    const resp = await fetch("{{ url_for('signature.list_signatures') }}");
    const sigs = await resp.json();

    sigs.forEach(sig => {
      const img = document.createElement("img");
      img.src = "{{ url_for('signature.serve_signature', sig_id='') }}" + sig.id; // adapt to sig.id from backend
      img.style.width = "100px";
      img.style.height = "40px";
      img.style.cursor = "pointer";

      img.addEventListener("click", () => {
        sigPreview.src = img.src;
        dragDiv.style.display = "block";
        dragDiv.style.left = "20px";
        dragDiv.style.top = "20px";
      });

      savedContainer.appendChild(img);
    });
  }

  loadSavedSignatures();

  // ---------- Place Signature on PDF ----------
  pdfCanvas.addEventListener("click", () => {
    if(dragDiv.style.display !== "block") return;
    const x = parseFloat(dragDiv.style.left) || 0;
    const y = parseFloat(dragDiv.style.top) || 0;
    const dpr = window.devicePixelRatio || 1;
    pdfCtx.drawImage(sigPreview, Math.floor(x*dpr), Math.floor(y*dpr), 150*dpr, 50*dpr);
    dragDiv.style.display = "none";
    sigPad.clear();
  });

  async function getDecryptedPngAsDataUrl(url) {
    const resp = await fetch(url);
    const blob = await resp.blob(); // decrypted PNG blob from backend
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result); // will be "data:image/png;base64,...."
        reader.readAsDataURL(blob);
    });
  }
  
  // ---------- Save Signed PDF ----------
  function uint8ToBase64(uint8Array){ let binary=''; const chunkSize=0x8000; for(let i=0;i<uint8Array.length;i+=chunkSize){const chunk=uint8Array.subarray(i,i+chunkSize);binary+=String.fromCharCode.apply(null,chunk);} return btoa(binary); }
  document.getElementById("saveDocument").addEventListener("click", async ()=>{
    const { PDFDocument } = PDFLib;
    const pdfBytes = await fetch(pdfUrl).then(r=>r.arrayBuffer());
    const pdfDoc = await PDFDocument.load(pdfBytes);

    if(sigPreview.src){
        const dataUrl = await getDecryptedPngAsDataUrl(sigPreview.src);
        const pngImage = await pdfDoc.embedPng(dataUrl);
        const page = pdfDoc.getPage(currentPage-1);
        const pageDims = page.getSize();

        // calculate PDF coordinates relative to canvas
        const scaleX = pageDims.width / pdfCanvas.width;
        const scaleY = pageDims.height / pdfCanvas.height;

        const xPdf = parseFloat(dragDiv.style.left) * scaleX;
        const yPdf = pageDims.height - (parseFloat(dragDiv.style.top) * scaleY) - (50 * scaleY); // adjust height if needed

        page.drawImage(pngImage, {
            x: xPdf,
            y: yPdf,
            width: 150 * scaleX,
            height: 50 * scaleY
        });
    }

    const pdfBytesSaved = await pdfDoc.save();
    const pdfBase64 = 'data:application/pdf;base64,' + uint8ToBase64(new Uint8Array(pdfBytesSaved));

    const resp = await fetch("{{ url_for('signature.save_signed_pdf') }}", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({pdf_base64:pdfBase64, original_filename:"{{ document.filename }}"})
    });
    const data = await resp.json();
    if(data.success) alert("Signed PDF saved: "+data.filename);
  });

  // Open modal and analyze
  document.getElementById("analyzeDocument").addEventListener("click", async () => {
    // Show modal
    analysisModal.show();

    // Show spinner
    spinnerDiv.style.display = "block";
    resultDiv.querySelector("p")?.remove(); // remove old result text if any

    // Fetch analysis
    try {
      const resp = await fetch("{{ url_for('signature.analyze_doc', doc_id=document.id) }}");
      const data = await resp.json();

      // Hide spinner
      spinnerDiv.style.display = "none";

      // Show analysis
      const p = document.createElement("p");
      p.innerText = data.analysis;
      resultDiv.appendChild(p);

    } catch (err) {
      spinnerDiv.style.display = "none";
      const p = document.createElement("p");
      p.innerText = "Error analyzing document.";
      resultDiv.appendChild(p);
    }
  });

  // Close modal with footer button
  document.getElementById("closeAnalysisModal").addEventListener("click", () => {
    analysisModal.hide();
  });

  // Optional: close modal after saving signed PDF
  document.getElementById("saveDocument").addEventListener("click", async () => {
    // ... your existing save PDF code ... 
    // Close modal if open
    analysisModal.hide();
  });
});
</script>

{% endblock %}
