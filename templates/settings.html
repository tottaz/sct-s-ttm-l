{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Application Settings</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="form-check form-switch mb-4">
                        <input class="form-check-input" type="checkbox" id="use_openai" name="use_openai" {% if
                            config.use_openai %}checked{% endif %}>
                        <label class="form-check-label fw-bold" for="use_openai">Use OpenAI for Analysis</label>
                        <div class="form-text">When enabled, the app will use OpenAI's models. When disabled, it will
                            use local Ollama.</div>
                    </div>

                    <div id="openai_settings" class="mb-4">
                        <label for="openai_api_key" class="form-label fw-bold">OpenAI API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="openai_api_key" name="openai_api_key"
                                value="{{ config.openai_api_key }}" placeholder="sk-...">
                            <button class="btn btn-outline-secondary" type="button" id="toggle_openai_key">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="ollama_base_url" class="form-label fw-bold">Ollama Base URL</label>
                        <input type="text" class="form-control" id="ollama_base_url" name="ollama_base_url"
                            value="{{ config.ollama_base_url }}" placeholder="http://localhost:11434">
                        <div class="form-text">The address where your local Ollama server is running.</div>
                    </div>

                    <div id="ollama_models_section">
                        <hr class="my-4">
                        <h6 class="mb-3 text-primary">Model Selection</h6>

                        <div class="mb-3">
                            <label for="vision_model" class="form-label fw-bold">Vision Model (for images/scanned
                                PDFs)</label>
                            <select class="form-select" id="vision_model" name="vision_model">
                                <option value="" {% if not config.vision_model %}selected{% endif %}>Auto-detect
                                </option>
                                {% for model in ollama_models %}
                                <option value="{{ model }}" {% if config.vision_model==model %}selected{% endif %}>{{
                                    model }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Select a vision-capable model (like llava or llama3.2-vision).</div>
                        </div>

                        <div class="mb-3">
                            <label for="chat_model" class="form-label fw-bold">Chat/Analysis Model</label>
                            <select class="form-select" id="chat_model" name="chat_model">
                                {% for model in ollama_models %}
                                <option value="{{ model }}" {% if config.chat_model==model or (not config.chat_model and
                                    model=='llama3.2:latest' ) %}selected{% endif %}>{{ model }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Used for analysis and translation. Default: llama3.2:latest</div>
                        </div>
                    </div>

                    <hr class="my-4">
                    <h6 class="mb-3 text-primary">Custom Prompts</h6>

                    <div class="mb-3">
                        <label for="translation_prompt" class="form-label fw-bold">Translation Prompt</label>
                        <textarea class="form-control" id="translation_prompt" name="translation_prompt" rows="3"
                            placeholder="Default prompt will be used if empty. Use {target_language} as placeholder.">{{ config.translation_prompt }}</textarea>
                        <div class="form-text">Customize how the AI translates documents.</div>
                    </div>

                    <div class="mb-3">
                        <label for="analysis_prompt" class="form-label fw-bold">Analysis Prompt</label>
                        <textarea class="form-control" id="analysis_prompt" name="analysis_prompt" rows="4"
                            placeholder="Default prompt will be used if empty. Use {language} and {style} as placeholders.">{{ config.analysis_prompt }}</textarea>
                        <div class="form-text">Customize the instructions for document analysis.</div>
                    </div>

                    <hr class="my-4">
                    <h6 class="mb-3 text-primary">Mail Settings (Gmail)</h6>

                    <div class="mb-3">
                        <label for="email" class="form-label fw-bold">Gmail Address</label>
                        <input type="email" class="form-control" id="email" name="email" value="{{ config.email }}"
                            placeholder="your.email@gmail.com">
                    </div>

                    <div class="mb-3">
                        <label for="app_password" class="form-label fw-bold">App Password</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="app_password" name="app_password"
                                value="{{ config.app_password }}" placeholder="your_gmail_app_password">
                            <button class="btn btn-outline-secondary" type="button" id="toggle_app_password">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">Generate an App Password in your Google Account settings if 2FA is
                            enabled.</div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                        <a href="{{ url_for('signature.index') }}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const useOpenAiSwitch = document.getElementById('use_openai');
    const openaiSettings = document.getElementById('openai_settings');

    function toggleOpenAiSettings() {
        openaiSettings.style.display = useOpenAiSwitch.checked ? 'block' : 'none';
    }

    function setupPasswordToggle(inputId, buttonId) {
        const input = document.getElementById(inputId);
        const button = document.getElementById(buttonId);
        const icon = button.querySelector('i');

        button.addEventListener('click', () => {
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('bi-eye', 'bi-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('bi-eye-slash', 'bi-eye');
            }
        });
    }

    setupPasswordToggle('openai_api_key', 'toggle_openai_key');
    setupPasswordToggle('app_password', 'toggle_app_password');

    useOpenAiSwitch.addEventListener('change', toggleOpenAiSettings);
    toggleOpenAiSettings(); // Initial state
</script>
{% endblock %}